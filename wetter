#!/usr/bin/env ruby
# frozen_string_literal: true

require 'gtk3'
require 'logger'
require 'yaml'
require 'fileutils'
require 'optparse'
# TODO Write out a comp[ete set of required gems to go on the Github for
#   future end-users and current developers
require_relative 'prefs.rb'

# wetter is an applet that is meant to serve as part of the AiDA system
# (Artificially-Intelligent Domestic Assistant) prounounced "Ay-Duh"

class Wetter
  include Wetter::Prefs::Window

  # Create constant representing the Preferences window-builder object
  # for if user clicks

  PrefsWin = Wetter::Prefs::Window.builder

  # Declare some much needed instance constants

  DefaultFilepath = 'application/run/' # Base run dir where both settings.conf
  # and stats.db will have their respective
  # domains.
  ConfDir  = "#{DefaultFilepath}conf/" # Dir containing settings.conf
  StatsDir = "#{DefaultFilepath}stats/" # Dir containing stats.conf

  # TODO Add argument parsing

  def create_yaml(mkdir = true)
    @logger.debug 'Received call to make conf file'

    conf_filepath  = DefaultFilepath
    stats_filepath = StatsDir
    conf_filepath  = ConfDir
    if mkdir
      @logger.debug 'Making conf directory'
      FileUtils.mkpath(conf_filepath)
      @logger.debug 'Conf path created'
      @logger.debug 'Creating conf file'
      @logger.debug 'Fetching default settings struct'
      temp_settings = Prefs::TempStructs.settings
      stat_settings = Prefs::TempStructs.stacks
      @logger.debug "Found default settings struct: #{temp_settings}"
      write_yaml(temp_settings)
      write_yaml(stat_settings)
      @logger.debug 'Creating stats path'
      FileUtils.mkpath("#{stats_filepath}")
      @logger.debug 'Stats path created!'
      @logger.debug 'Initial conf/stats files created!'
    else
      @logger.debug 'Skipping file creation, files found!'

    end

  end

  def load_settings(filepath = DefaultFilepath)
    puts filepath.to_s

    if File.exist?(filepath) && File.directory?(filepath)
      unless File.exist?("#{filepath}conf/settings.conf")
        create_yaml("#{filepath}conf/settings.conf")
      end
      unless File.exist?("#{filepath}stats/stats.db")
        create_yaml("#{filepath}stats/stats.db")
      end
      @settings = YAML.load_file("#{filepath}conf/settings.conf")
    end

    @logger.debug "Checking to see if #{filepath} exists and is a directory"
    if File.exist?(filepath) && File.directory?
      conf_file = "#{filepath}/wetter.conf"
      @logger.debug "Both are true, seeing if #{conf_file} exists"
      if File.exist(conf_file)
        @logger.debug 'Conf file found, parsing'
        loaded_settings = YAML.load_file(conf_file).read
        if loaded_settings == temp_struct
          @logger.debug 'Found default conf struct in conf file, loading'
          loaded_settings = temp_struct
          @logger.debug "Loaded settings as: #{loaded_settings}"
          save_settings(loaded_settings)
        else
          if loaded_settings.key?[:api_key] and loaded_settings.key?[:location]
            @logger.debug 'Found API Key and Location fields'
            for item in loaded_settings

            end
          end
        end
      end
    end
    if File.exist?("#{filepath}/wetter.conf")
    end

    if File.exist?(filepath)
      temp_settings = YAML.load_file(filepath)
      if temp_settings.key?(:api_key)
        if temp_settings[:api_key].nil?
          @logger.debug 'API key unset, though it has an entry'
          @api_buffer.text = 'Not set'
        else
          @logger.info "Found API key: #{temp_settings[:api_key]}"
          @api_buffer.text = temp_settings[:api_key].to_s
        end
      else
        @logger.info 'Unable to find conf path, creating...'
        create_conf
      end

    end

  end

  def save_settings
    settings_file = File.new @settings_filepath, 'w+'
    settings_yaml = YAML.load_file(settings_file)
    if settings_yaml.has_key?(:api_key)
      @settings[:api_key] = settings_yaml[:api_key].to_s
    else
      @settings[:api_key] = nil
    end

    if settings_yaml.has_key?(:location)
      @settings[:location] = settings_yaml[:location].to_s
    else
      @settings[:location] = nil
    end
    settings_file.write @settings
  end

  def start_logger
    @logger       = Logger.new(STDOUT)
    @logger.level = Logger::DEBUG
    @logger.info 'Logger started!'
  end

  def start_builder(glade_path)
    @builder = Gtk::Builder.new
    @logger.debug 'Starting UI builder object'
    @builder.add_from_file(glade_path)
    @logger.debug 'Setting up connect signals with handlers'
    @builder.connect_signals { |handler| method (handler) }
    @logger.debug 'Signals connected!'
    @logger.debug 'UI builder started!'
  end

  def build_windows
    @logger.debug 'Building window objects'
    @main_window  = @builder.get_object('WetterApplicationWindow')
    @prefs_window = @builder.get_object('PrefWindow')
    @logger.debug 'Window objects built'
  end

  def splash_hide
    @splash.hide
  end

  #  def show_splash
  #    @splash = @builder.get_object('splash_window')
  #    @splash.show
  #0  end

  def initialize(glade_path)

    # Run start-up jobs
    start_logger
    @logger.debug 'Running start jobs'
    load_settings
    start_builder(glade_path)
  #  show_splash
    @logger.debug 'Starting build job for windows'
    build_windows

  end

  def build_pref_fields
    @logger.debug 'Building Preference Fields'
    @api_buffer = @builder.get_object 'ApiKeyEntryBuffer'
    @api_show   = @builder.get_object 'ApiKeyEntry'
    @logger.debug 'Built API preference fields'
  end

  def not_yet_implemented
    puts 'Not yet implemented'
  end

  def on_ButtonPrefs_clicked
    @logger.debug 'Received click on Preferences button'
    puts @settings
    build_pref_fields
    @api_buffer.text = if !@settings[:api_key].nil?
                         @settings[:api_key]
                       else
                         'This has not been set'
                       end
    if @settings[:api_key].nil?
      ''
    end

    @logger.debug("API Key is: #{@api_buffer.text}")
    @prefs_window.show
    @api_show.text = (@api_buffer.text)
  end

  def on_ButtonRefresh_clicked
    not_yet_implemented
  end

  def on_ApiKeyEntry_changed
    @api_buffer.text    = (@api_show.text)
    @settings[:api_key] = @api_buffer.text
  end

  def on_ButtonQuit_clicked
    @main_window.destroy
    begin
      exit
    rescue SystemExit
      p 'This is a clean exit'
      quit
    end
  end

  # Handlers for Preferences window signals
  # FIXME 'ok' button doesn't save, nor does it close the window
  def on_PrefsWinButtonOk_clicked
    @logger.debug('Received click on OK button in preferences window')
    @logger.debug("Settings state: #{@settings}")
    begin
      @logger.debug('Opening file in write mode')
      File.open('conf/settings.conf', 'w') do |file|
        @logger.debug('Writing settings file...')
        file.write @settings.to_yaml
        @logger.debug('File written')
      end
    rescue StandardError => e
      @logger.error 'I do not have permission to save settings:'
      @logger.error e.message

    end
  end

  def on_PrefsWinButtonCancel_clicked
    @logger.debug('Received click on cancel button, hiding window')
    @prefs_window.hide
    @logger.debug('Preference window hidden')
  end

  def run
    @main_window.show
    Gtk.main
  end

  def quit
    Gtk.main_quit
  end
end
puts "#{ARGV}"
Wetter.new('wetter.ui').run
